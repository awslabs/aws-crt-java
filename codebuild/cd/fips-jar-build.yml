version: 0.2
#this buildspec assumes the aws-common-runtime/ubuntu-16.04 image
# This job is responsible for artifacting the JAR which will have all of the other shared libs stuffed
# into it once all platforms are built and artifacted
phases:
  install:
    commands:
      - sudo add-apt-repository ppa:openjdk-r/ppa
      - sudo apt-get update -y
      - sudo apt-get install openjdk-11-jdk-headless maven wget unzip -y -f
  build:
    commands:
      - cd $CODEBUILD_SRC_DIR/aws-crt-java
      # upload artifacts to S3
      - export GIT_TAG=$(git describe --tags)
      - mkdir -p target/cmake-build/lib
      # prepare FIPS uber jar, with the FIPS libs
      - aws s3 cp --recursive s3://aws-crt-java-pipeline/${GIT_TAG}/fips_lib $CODEBUILD_SRC_DIR/aws-crt-java/target/cmake-build/lib
      - mvn -B package -DskipTests -Dshared-lib.skip=true -Dcrt.classifier=fips-compat

  post_build:
    commands:
      # upload artifacts to S3
      - export GIT_TAG=$(git describe --tags)
      - aws s3 cp --recursive --exclude "*" --include "aws-crt*.jar" ./target s3://aws-crt-java-pipeline/${GIT_TAG}/jar

cache:
  paths:
    - "/root/.m2/**/*"
